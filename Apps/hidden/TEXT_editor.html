<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texto Studio MDI - Editor WYSWYG</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <!-- Scripts Base -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- PLANTILLAS (TEMPLATES) -->
    <template id="tpl-editor">
        <div class="editor-container d-flex flex-column h-100">
            <div class="toolbar btn-toolbar p-1 bg-light border-bottom" role="toolbar">
                <div class="btn-group btn-group-sm me-2">
                    <button class="btn btn-outline-secondary" onclick="app.exec('bold')" title="Negrita"><i class="bi bi-type-bold"></i></button>
                    <button class="btn btn-outline-secondary" onclick="app.exec('italic')" title="Cursiva"><i class="bi bi-type-italic"></i></button>
                    <button class="btn btn-outline-secondary" onclick="app.exec('underline')" title="Subrayado"><i class="bi bi-type-underline"></i></button>
                </div>
                <div class="btn-group btn-group-sm me-2">
                    <button class="btn btn-outline-secondary" onclick="app.exec('justifyLeft')" title="Izquierda"><i class="bi bi-justify-left"></i></button>
                    <button class="btn btn-outline-secondary" onclick="app.exec('justifyCenter')" title="Centro"><i class="bi bi-justify-center"></i></button>
                    <button class="btn btn-outline-secondary" onclick="app.exec('insertUnorderedList')" title="Lista"><i class="bi bi-list-ul"></i></button>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" onclick="app.saveFile(this)" title="Guardar en DB"><i class="bi bi-cloud-arrow-up"></i></button>
                    <button class="btn btn-success" onclick="app.downloadFile(this)" title="Descargar"><i class="bi bi-download"></i></button>
                </div>
            </div>
            <div contenteditable="true" class="wysiwyg-editor p-3 flex-grow-1" spellcheck="false">
                Escribe aquí tu contenido...
            </div>
            <div class="editor-footer px-2 py-1 bg-light border-top d-flex justify-content-between">
                <small class="text-muted status-msg">Documento nuevo</small>
                <small class="text-muted char-count">0 caracteres</small>
            </div>
        </div>
    </template>

    <template id="tpl-explorer">
        <div class="p-2 h-100 d-flex flex-column">
            <h6><i class="bi bi-folder2-open"></i> Archivos Guardados</h6>
            <div class="list-group list-group-flush explorer-list overflow-auto" style="flex: 1;">
                <!-- Lista de archivos de Dexie -->
            </div>
            <div class="mt-2 border-top pt-2">
                <input type="file" id="importFile" class="d-none" onchange="app.importFromFile(event)">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="$('#importFile').click()">
                    <i class="bi bi-file-earmark-plus"></i> Importar desde PC
                </button>
            </div>
        </div>
    </template>

    <style>
        :root {
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 70px;
            --aside-width: 260px;
            --transition-speed: 0.3s;
        }

        body { overflow: hidden; height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        #header { height: 60px; z-index: 1030; }
        #footer { height: 40px; z-index: 1030; }
        #wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }

        #nav-panel { width: var(--sidebar-width); transition: width var(--transition-speed); border-right: 1px solid #dee2e6; background: #f8f9fa; z-index: 1020; overflow: hidden; display: flex; flex-direction: column; }
        #nav-panel.collapsed { width: var(--sidebar-collapsed-width); }
        #nav-panel.collapsed .nav-text, #nav-panel.collapsed small { display: none; }

        #aside-panel { width: var(--aside-width); transition: margin-right var(--transition-speed); border-left: 1px solid #dee2e6; background: #f8f9fa; z-index: 1020; }
        #aside-panel.collapsed { margin-right: calc(var(--aside-width) * -1); }

        #main-content { flex: 1; position: relative; background: #cbd3da; overflow: hidden; }

        /* Ventanas MDI */
        .app-window {
            position: absolute; width: 500px; height: 400px; background: white; border: 1px solid #adb5bd;
            border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden;
        }
        .window-header {
            background: #f1f3f5; padding: 8px 12px; cursor: move; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid #dee2e6; user-select: none;
        }
        .window-title { font-size: 0.85rem; font-weight: bold; color: #495057; }
        .window-body { flex: 1; overflow: hidden; background: white; position: relative; }

        /* Editor WYSIWYG */
        .wysiwyg-editor { outline: none; font-size: 1rem; line-height: 1.5; color: #333; overflow-y: auto; }
        .wysiwyg-editor:focus { background: #fff; }

        .win-btn { border: none; background: none; font-size: 0.9rem; color: #6c757d; padding: 0 5px; }
        .win-btn:hover { color: #000; }
        .win-btn-close:hover { color: #dc3545; }

        .nav-link { color: #495057; padding: 10px 15px; border-radius: 6px; margin-bottom: 4px; cursor: pointer; text-decoration: none; display: block; }
        .nav-link:hover { background-color: #dee2e6; }

        /* Dark Mode */
        body.dark-mode { background-color: #1a1d20; color: #e9ecef; }
        body.dark-mode #main-content { background-color: #000; }
        body.dark-mode .app-window, body.dark-mode .window-body, body.dark-mode .wysiwyg-editor { background-color: #2c3034; color: #eee; }
        body.dark-mode .window-header, body.dark-mode .bg-light { background-color: #343a40 !important; color: #fff; }
        body.dark-mode .nav-link { color: #ccc; }
    </style>
</head>
<body>

    <header id="header" class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4">
        <button class="btn btn-light border me-3" onclick="ui.togglePanel('nav')"><i class="bi bi-list"></i></button>
        <span class="navbar-brand fw-bold text-primary"><i class="bi bi-pen-fill"></i> TEXTO STUDIO MDI</span>
        
        <div class="ms-auto d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="app.createWindow('editor', 'Nuevo Documento')">
                <i class="bi bi-plus-lg"></i> Nuevo
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="ui.togglePanel('aside')"><i class="bi bi-layout-sidebar-reverse"></i></button>
        </div>
    </header>

    <div id="wrapper">
        <nav id="nav-panel" class="p-3">
            <small class="text-uppercase fw-bold text-muted">Documentos</small>
            <div class="nav flex-column mt-2">
                <a class="nav-link" onclick="app.createWindow('editor', 'Editor de Texto')">
                    <span class="nav-icon"><i class="bi bi-file-earmark-richtext"></i></span> <span class="nav-text ms-2">Nuevo Editor</span>
                </a>
                <a class="nav-link" onclick="app.createWindow('explorer', 'Explorador')">
                    <span class="nav-icon"><i class="bi bi-folder"></i></span> <span class="nav-text ms-2">Abrir Recientes</span>
                </a>
            </div>
            
            <div class="mt-auto">
                <hr>
                <div class="form-check form-switch small">
                    <input class="form-check-input" type="checkbox" id="themeSwitch" onclick="ui.toggleTheme()">
                    <label class="form-check-label" for="themeSwitch"><i class="bi bi-moon"></i></label>
                </div>
            </div>
        </nav>

        <main id="main-content">
            <!-- Espacio para ventanas -->
        </main>

        <aside id="aside-panel" class="p-3">
            <h6 class="fw-bold">Información MDI</h6>
            <p class="small text-muted">Cada ventana es una instancia independiente. Los cambios se guardan localmente en tu navegador.</p>
            <hr>
            <div id="active-windows-list" class="small">
                <!-- Lista dinámica -->
            </div>
        </aside>
    </div>

    <footer id="footer" class="bg-white border-top d-flex align-items-center px-4 justify-content-between">
        <small class="text-muted">Desarrollado con Studio MDI v2.0</small>
        <div id="status-bar" class="small text-primary">Listo para escribir</div>
    </footer>

    <script>
        // Configuración de Base de Datos
        const db = new Dexie("TextoStudioDB");
        db.version(1).stores({
            docs: '++id, title, content, updated',
            settings: 'id, value'
        });

        let windowCount = 0;

        const app = {
            async init() {
                const theme = await db.settings.get('theme');
                if (theme?.value === 'dark') ui.toggleTheme(true);
                this.updateGlobalStatus();
            },

            createWindow(viewId, title, initialData = null) {
                windowCount++;
                const main = $('#main-content');
                const winId = `win-${windowCount}`;
                
                const winHtml = `
                    <div id="${winId}" class="app-window" style="top: ${40 + (windowCount * 20)}px; left: ${40 + (windowCount * 20)}px;">
                        <div class="window-header">
                            <span class="window-title"><i class="bi bi-file-text"></i> ${title}</span>
                            <div class="window-controls">
                                <button class="win-btn win-btn-close" title="Cerrar" onclick="app.closeWindow('${winId}')"><i class="bi bi-x-lg"></i></button>
                            </div>
                        </div>
                        <div class="window-body" id="body-${winId}"></div>
                    </div>
                `;

                main.append(winHtml);

                const template = document.getElementById(`tpl-${viewId}`);
                if (template) {
                    const clone = template.content.cloneNode(true);
                    $(`#body-${winId}`).append(clone);
                }

                $(`#${winId}`).draggable({
                    handle: ".window-header",
                    containment: "#main-content",
                    stack: ".app-window"
                }).resizable({
                    containment: "#main-content",
                    minHeight: 200, minWidth: 300
                }).mousedown(function() {
                    $(this).css('z-index', ++windowCount + 100);
                });

                // Inicializar datos si existen
                if (initialData && viewId === 'editor') {
                    $(`#body-${winId} .wysiwyg-editor`).html(initialData.content);
                    $(`#body-${winId} .status-msg`).text("Cargado: " + initialData.title);
                    $(`#${winId}`).data('doc-id', initialData.id);
                }

                if (viewId === 'explorer') this.refreshExplorer(winId);

                this.updateAside();
            },

            exec(command) {
                document.execCommand(command, false, null);
            },

            async saveFile(btn) {
                const win = $(btn).closest('.app-window');
                const winId = win.attr('id');
                const content = win.find('.wysiwyg-editor').html();
                const currentId = win.data('doc-id');
                
                const title = prompt("Nombre del documento:", currentId ? "Documento" : "Sin título") || "Sin título";
                
                if (currentId) {
                    await db.docs.update(currentId, { title, content, updated: new Date() });
                } else {
                    const id = await db.docs.add({ title, content, updated: new Date() });
                    win.data('doc-id', id);
                }

                win.find('.status-msg').text("Guardado: " + new Date().toLocaleTimeString());
                this.updateGlobalStatus();
            },

            downloadFile(btn) {
                const win = $(btn).closest('.app-window');
                const content = win.find('.wysiwyg-editor').html();
                const blob = new Blob([content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "documento.html";
                a.click();
            },

            async importFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.createWindow('editor', file.name, { content: e.target.result, title: file.name });
                };
                reader.readAsText(file);
            },

            async refreshExplorer(winId) {
                const docs = await db.docs.reverse().toArray();
                const list = $(`#body-${winId} .explorer-list`);
                list.empty();
                
                if (docs.length === 0) {
                    list.append('<div class="p-3 text-center text-muted small">No hay archivos guardados</div>');
                } else {
                    docs.forEach(doc => {
                        list.append(`
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-2">
                                <div role="button" onclick="app.openDoc(${doc.id})" class="flex-grow-1">
                                    <div class="fw-bold small">${doc.title}</div>
                                    <small class="text-muted" style="font-size: 0.7rem">${new Date(doc.updated).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-sm text-danger" onclick="app.deleteDoc(${doc.id}, '${winId}')"><i class="bi bi-trash"></i></button>
                            </div>
                        `);
                    });
                }
            },

            async openDoc(id) {
                const doc = await db.docs.get(id);
                this.createWindow('editor', doc.title, doc);
            },

            async deleteDoc(id, winId) {
                if(confirm("¿Eliminar permanentemente?")) {
                    await db.docs.delete(id);
                    this.refreshExplorer(winId);
                    this.updateGlobalStatus();
                }
            },

            closeWindow(winId) {
                $(`#${winId}`).remove();
                this.updateAside();
            },

            updateAside() {
                const list = $('#active-windows-list');
                list.empty();
                $('.app-window').each(function() {
                    const title = $(this).find('.window-title').text();
                    const id = $(this).attr('id');
                    list.append(`<div class="badge bg-secondary m-1 p-2 w-100 text-start">${title}</div>`);
                });
            },

            async updateGlobalStatus() {
                const count = await db.docs.count();
                $('#status-bar').text(`Archivos en DB: ${count}`);
            }
        };

        const ui = {
            togglePanel(id) {
                $(`#${id}-panel`).toggleClass('collapsed');
            },
            toggleTheme(init = false) {
                const body = $('body');
                if (init) {
                    body.addClass('dark-mode');
                    $('#themeSwitch').prop('checked', true);
                } else {
                    body.toggleClass('dark-mode');
                    db.settings.put({ id: 'theme', value: body.hasClass('dark-mode') ? 'dark' : 'light' });
                }
            }
        };

        $(document).ready(() => app.init());
    </script>
</body>
</html>