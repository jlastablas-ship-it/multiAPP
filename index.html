<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Modular Pro - Gestión de Marcadores</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <style>
        :root { --transition-speed: 0.3s; }
        
        /* Dark Mode Variables Default */
        body.dark-mode {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        .dark-mode header, .dark-mode nav, .dark-mode aside, .dark-mode footer, .dark-mode .window-card {
            background-color: #1e293b !important;
            border-color: #334155 !important;
            color: #f1f5f9 !important;
        }
        .dark-mode main {
            background-color: #0f172a !important;
            background-image: radial-gradient(#334155 1px, transparent 1px) !important;
        }
        .dark-mode .window-header {
            background-color: #334155 !important;
            border-bottom-color: #475569 !important;
        }
        .dark-mode input, .dark-mode .bg-gray-50, .dark-mode .bg-white {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }
        .dark-mode .text-gray-500, .dark-mode .text-gray-400 {
            color: #94a3b8 !important;
        }
        .dark-mode .inspector-section-header {
            background-color: #334155 !important;
            color: #cbd5e1 !important;
        }

        body { overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s ease; }
        .collapsible { transition: all var(--transition-speed) ease-in-out; overflow: hidden; position: relative; }
        .collapsed-h { height: 0 !important; min-height: 0 !important; padding: 0 !important; margin: 0 !important; border: 0 !important; }
        .collapsed-w { width: 0 !important; min-width: 0 !important; padding: 0 !important; margin: 0 !important; border: 0 !important; }
        
        .nav-expanded { width: 256px; min-width: 256px; }
        .nav-collapsed { width: 64px; min-width: 64px; }
        .nav-collapsed .nav-text, .nav-collapsed .nav-header-text, .nav-collapsed .win-controls, .nav-collapsed .nav-input-group { display: none !important; }
        .nav-collapsed .nav-item-btn { justify-content: center; padding-left: 0; padding-right: 0; }
        
        main { flex: 1; overflow: auto; position: relative; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        
        /* Window Styles */
        .window-card { position: absolute; width: 600px; height: 450px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; z-index: 10; overflow: hidden; transition: width 0.2s, height 0.2s, top 0.2s, left 0.2s; }
        .window-header { padding: 8px 12px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; cursor: move; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .window-body { flex: 1; overflow: hidden; position: relative; }
        .window-body iframe { width: 100%; height: 100%; border: none; background: white; }
        
        /* Window States */
        .window-maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; border-radius: 0; }
        .window-minimized { height: 38px !important; width: auto !important; min-width: 160px; overflow: hidden; }
        .window-minimized .window-body { display: none; }
        .btn-win-tool { @apply p-1 rounded hover:bg-gray-200 transition-colors flex items-center justify-center text-gray-500; }

        /* Inspector Styles */
        .inspector-section-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-size: 10px; font-weight: bold; color: #475569; text-transform: uppercase; }
        .inspector-section-header:hover { background: #e2e8f0; }
        .inspector-section-content { display: none; padding: 8px; background: #fff; font-family: 'Fira Code', monospace; font-size: 10px; overflow-x: auto; }
        .inspector-section-content.active { display: block; }

        .code-snippet { background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 4px; white-space: pre-wrap; word-break: break-all; font-size: 9px; color: #334155; max-height: 200px; overflow-y: auto; }
        
        /* Inspector Tabs */
        .ins-tab-btn { padding: 4px 8px; font-size: 9px; font-weight: bold; border-bottom: 2px solid transparent; color: #94a3b8; cursor: pointer; }
        .ins-tab-btn.active { border-color: #3b82f6; color: #3b82f6; }
        .ins-tab-content { display: none; margin-top: 8px; }
        .ins-tab-content.active { display: block; }
        .preview-mini-frame { width: 100%; height: 120px; border: 1px solid #e2e8f0; border-radius: 4px; background: white; }

        /* Tree View Styles */
        .dom-tree-node { margin-left: 12px; border-left: 1px dashed #cbd5e1; padding-left: 8px; }
        .dom-tree-label { display: flex; align-items: center; gap: 4px; padding: 2px 0; }
        .dom-tree-toggle { cursor: pointer; width: 12px; font-size: 8px; display: inline-block; }
        
        .btn-nav-locked { opacity: 0.4; cursor: not-allowed !important; pointer-events: none; }
        .iframe-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 20; }
        .ui-draggable-dragging .iframe-overlay, .ui-resizable-resizing .iframe-overlay { display: block !important; }

        .expand-trigger { position: absolute; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); z-index: 50; display: none; transition: opacity 0.2s; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900" id="app-body">

    <button id="header-expand-btn" onclick="toggleSection('header')" class="expand-trigger top-0 left-1/2 -translate-x-1/2 px-4 py-1 rounded-b-lg border-t-0 text-[10px] font-bold uppercase tracking-widest">
        Expandir Header
    </button>

    <header id="header" class="collapsible flex items-center justify-between px-6 py-3 bg-white border-b shadow-sm min-h-[64px] z-40">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold font-mono tracking-tighter text-blue-600">APP_CORE v2.8.5</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleSection('header')" class="text-[10px] font-bold opacity-50 hover:opacity-100 uppercase border px-2 py-1 rounded">Ocultar Header</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <nav id="nav" class="collapsible nav-expanded bg-white border-r flex flex-col z-30">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="nav-header-text font-semibold text-sm text-gray-500 uppercase">Menú</span>
                <button onclick="toggleNav()" class="p-1 hover:bg-gray-100 rounded">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>

            <div class="p-3 space-y-4">
                <label class="flex items-center gap-3 w-full px-3 py-2 rounded-lg cursor-pointer bg-blue-600 text-white hover:bg-blue-700 shadow-md nav-item-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span class="nav-text text-xs font-bold uppercase">Subir Módulo</span>
                    <input type="file" accept=".html" class="hidden" onchange="handleHtmlUpload(event)">
                </label>

                <div class="nav-input-group space-y-2">
                    <div class="flex gap-1">
                        <input type="text" id="external-url" placeholder="https://..." class="w-full text-xs p-2 rounded border">
                        <button onclick="handleUrlSubmit()" class="p-2 bg-gray-200 rounded hover:bg-blue-500 hover:text-white">GO</button>
                    </div>
                    <button onclick="autoloadBookmarks()" class="w-full py-1.5 px-2 bg-gray-800 text-white text-[9px] font-bold uppercase rounded hover:bg-black transition-colors flex items-center justify-center gap-2">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                        <span class="nav-text">Auto-Load URLs</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-2 py-4 border-t" id="active-windows-list">
                <div id="win-links-container" class="space-y-1"></div>
            </div>
            
            <div class="p-2 border-t space-y-1">
                <button id="btn-nav-db" onclick="openInternalWindow('db')" class="nav-item-btn flex items-center gap-3 w-full px-3 py-2 rounded text-green-600 hover:bg-green-50 text-sm font-medium">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                    <span class="nav-text">Database</span>
                </button>
                <button id="btn-nav-config" onclick="openInternalWindow('config')" class="nav-item-btn flex items-center gap-3 w-full px-3 py-2 rounded text-red-500 hover:bg-red-50 text-sm font-medium">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    <span class="nav-text">Settings</span>
                </button>
            </div>
        </nav>

        <main id="main" class="flex-1 bg-white relative">
            <div id="desktop-bg" class="absolute inset-0 pointer-events-none opacity-5 flex items-center justify-center">
                <span class="text-6xl font-black text-gray-400 select-none uppercase">Editor Workspace</span>
            </div>
        </main>

        <aside id="aside" class="collapsible w-96 bg-gray-50 border-l flex flex-col z-30">
            <div class="p-4 flex justify-between items-center border-b bg-white shrink-0">
                <span class="font-bold text-[10px] text-gray-500 uppercase tracking-widest">Inspector Avanzado</span>
                <button onclick="toggleSection('aside')" class="p-1 hover:bg-gray-200 rounded">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div id="inspector-root" class="flex-1 overflow-y-auto pb-10">
                <div class="p-10 text-center opacity-30 text-xs">
                    <p>Selecciona una ventana para iniciar inspección.</p>
                </div>
            </div>
        </aside>

        <button id="aside-expand-btn" onclick="toggleSection('aside')" class="hidden absolute right-0 top-1/2 -translate-y-1/2 bg-white border border-r-0 p-2 shadow-lg z-40 rounded-l-lg">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"></polyline></svg>
        </button>
    </div>

    <footer id="footer" class="collapsible bg-white border-t p-2 flex justify-between items-center text-[10px] font-mono min-h-[32px]">
        <div class="flex gap-4 px-4">
            <span id="storage-status" class="text-green-600">DEXIE: ONLINE</span>
            <span class="text-gray-400">READY</span>
        </div>
        <button onclick="toggleSection('footer')" class="opacity-50 hover:opacity-100 px-4">Ocultar Footer</button>
    </footer>

    <button id="footer-expand-btn" onclick="toggleSection('footer')" class="expand-trigger bottom-0 left-1/2 -translate-x-1/2 px-4 py-1 rounded-t-lg border-b-0 text-[10px] font-bold uppercase widest">
        Expandir Footer
    </button>

    <script>
        let db, state;

        db = new Dexie("AppDB_V3"); 
        db.version(3).stores({
            settings: "key, value",
            bookmarks: "++id, url, title"
        });

        state = {
            activeWindows: [],
            focusedWindowId: null,
            internalOpen: { db: false, config: false },
            selectedDomNodes: new Set(),
            darkMode: false
        };

        const ICONS = {
            web: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
            module: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
            db: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`,
            config: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`
        };

        // Initialize Theme
        async function initTheme() {
            const savedTheme = await db.settings.get('darkMode');
            if (savedTheme && savedTheme.value) {
                toggleDarkMode(true);
            }
        }

        async function toggleDarkMode(isInit = false) {
            state.darkMode = isInit ? true : !state.darkMode;
            if (state.darkMode) {
                $('#app-body').addClass('dark-mode');
            } else {
                $('#app-body').removeClass('dark-mode');
            }
            await db.settings.put({ key: 'darkMode', value: state.darkMode });
            if (state.focusedWindowId && $(`#${state.focusedWindowId}`).data('type') === 'config') {
                renderConfig(state.focusedWindowId);
            }
        }

        async function openInternalWindow(type) {
            if (state.internalOpen[type]) return;
            state.internalOpen[type] = true;
            updateSystemNavButtons();
            createWindowCard(type === 'db' ? 'Database' : 'Settings', null, type);
        }

        function createWindowCard(title, content, type = 'module') {
            const windowId = `win-${Date.now()}`;
            const isInternal = type === 'db' || type === 'config';
            
            // Resolve relative path if content is not a full URL and not internal
            let resolvedUrl = content;
            if (!isInternal && content) {
                const isAbsolute = /^https?:\/\//i.test(content) || content.startsWith('data:') || content.startsWith('blob:');
                if (!isAbsolute) {
                    try {
                        // FIX: Detect if we are in a blob environment or sandbox
                        let base = window.location.href;
                        if (base.startsWith('blob:')) {
                            // If base is a blob, we can't easily resolve relative paths against it for external assets
                            // unless we use the origin. But usually relative assets work if the browser handles it.
                            // We try to use URL constructor safely.
                            resolvedUrl = new URL(content, window.location.origin).href;
                        } else {
                            resolvedUrl = new URL(content, base).href;
                        }
                    } catch(e) {
                        console.error("Error resolving path:", e);
                        // Fallback: Just use the content as is
                        resolvedUrl = content;
                    }
                }
            }

            const cardHtml = `
                <div id="${windowId}" class="window-card" data-type="${type}" onclick="focusWindow('${windowId}')">
                    <div class="window-header">
                        <span class="text-[10px] font-bold truncate opacity-80 uppercase mr-4">${title}</span>
                        <div class="flex items-center gap-1">
                            <button onclick="toggleMinimize('${windowId}')" class="btn-win-tool" title="Minimizar">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>
                            </button>
                            <button onclick="toggleMaximize('${windowId}')" class="btn-win-tool" title="Maximizar">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                            </button>
                            <button onclick="toggleFullScreen('${windowId}')" class="btn-win-tool" title="Full Screen">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                            </button>
                            <button onclick="removeWindow('${windowId}', '${type}')" class="btn-win-tool text-red-500 ml-1" title="Cerrar">✕</button>
                        </div>
                    </div>
                    <div class="window-body">
                        <div class="iframe-overlay"></div>
                        ${isInternal ? 
                            `<div id="content-${windowId}" class="p-4 h-full overflow-auto bg-white text-xs font-mono"></div>` : 
                            `<iframe id="iframe-${windowId}" src="${resolvedUrl}" onload="inspectIframe('${windowId}')" onerror="handleIframeError('${windowId}')"></iframe>`
                        }
                    </div>
                </div>
            `;
            
            $('#main').append(cardHtml);
            const win = $(`#${windowId}`);
            win.css({ top: (50 + state.activeWindows.length * 20) + 'px', left: (50 + state.activeWindows.length * 20) + 'px' });
            
            win.draggable({ 
                handle: ".window-header", 
                containment: "#main", 
                stack: ".window-card",
                start: () => win.hasClass('window-maximized') ? false : true
            }).resizable({
                start: () => (win.hasClass('window-maximized') || win.hasClass('window-minimized')) ? false : true
            });
            
            state.activeWindows.push({ id: windowId, title: title, type: type, url: resolvedUrl });
            updateWindowsNav();
            focusWindow(windowId);
            
            if (type === 'db') renderDB(windowId);
            if (type === 'config') renderConfig(windowId);
        }

        function handleIframeError(id) {
            console.error("Iframe failed to load:", id);
        }

        // --- WINDOW MANAGEMENT ACTIONS ---

        function toggleMaximize(id) {
            const win = $(`#${id}`);
            win.removeClass('window-minimized');
            win.toggleClass('window-maximized');
            
            if (win.hasClass('window-maximized')) {
                win.draggable('disable');
            } else {
                win.draggable('enable');
            }
        }

        function toggleMinimize(id) {
            const win = $(`#${id}`);
            win.removeClass('window-maximized').draggable('enable');
            win.toggleClass('window-minimized');
        }

        function toggleFullScreen(id) {
            const elem = document.getElementById(id);
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => console.error(err));
            } else {
                document.exitFullscreen();
            }
        }

        // --- BOOKMARKS LOGIC ---

        async function autoloadBookmarks() {
            const all = await db.bookmarks.toArray();
            if (all.length === 0) return;
            all.forEach((bm, index) => {
                setTimeout(() => {
                    createWindowCard(bm.title, bm.url, 'web');
                }, index * 150);
            });
        }

        async function addBookmark() {
            const title = document.getElementById('bm-title').value;
            const url = document.getElementById('bm-url').value;
            if (!title || !url) return;
            
            let finalUrl = url;
            // Only prepend https if it's not a relative path and doesn't have a protocol
            const isRelative = url.startsWith('.') || url.startsWith('/');
            const hasProtocol = /^https?:\/\//i.test(url) || url.startsWith('blob:');
            
            if(!isRelative && !hasProtocol) {
                finalUrl = 'https://' + finalUrl;
            }

            await db.bookmarks.add({ title, url: finalUrl });
            document.getElementById('bm-title').value = '';
            document.getElementById('bm-url').value = '';
            renderConfig(state.focusedWindowId);
        }

        async function deleteBookmark(id) {
            await db.bookmarks.delete(id);
            renderConfig(state.focusedWindowId);
        }

        // --- INSPECTOR CORE ---

        function switchInsTab(btn, tabId) {
            const container = $(btn).closest('.ins-tabs-container');
            container.find('.ins-tab-btn').removeClass('active text-blue-600 border-blue-600').addClass('text-gray-400 border-transparent');
            $(btn).addClass('active text-blue-600 border-blue-600');
            
            container.find('.ins-tab-content').removeClass('active');
            container.find(`.ins-tab-content[data-tab="${tabId}"]`).addClass('active');
        }

        function toggleInsItem(header) {
            $(header).next('.ins-item-body').toggleClass('hidden');
            const icon = $(header).find('.toggle-icon-item');
            icon.text(icon.text() === '▼' ? '▶' : '▼');
        }

        function renderElementInspector(title, htmlContent, idPrefix) {
            const escaped = escapeHtml(htmlContent);
            const previewBlob = `
                <html>
                    <head>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>body{padding:10px;font-family:sans-serif;background-image:radial-gradient(#eee 1px, transparent 1px);background-size:10px 10px;}<\/style>
                    </head>
                    <body>${htmlContent}</body>
                </html>
            `;

            return `
                <div class="border border-gray-200 rounded-md mb-2 overflow-hidden shadow-sm">
                    <div class="bg-gray-100 p-2 flex justify-between items-center cursor-pointer hover:bg-gray-200" onclick="toggleInsItem(this)">
                        <span class="text-[9px] font-bold text-gray-600 uppercase truncate">${title}</span>
                        <span class="toggle-icon-item text-[8px]">▶</span>
                    </div>
                    <div class="ins-item-body hidden p-2 bg-white ins-tabs-container">
                        <div class="flex border-b mb-2">
                            <div class="ins-tab-btn active text-blue-600 border-blue-600" onclick="switchInsTab(this, 'code')">CODE</div>
                            <div class="ins-tab-btn" onclick="switchInsTab(this, 'preview')">PREVIEW</div>
                        </div>
                        <div class="ins-tab-content active" data-tab="code">
                            <div class="code-snippet">${escaped}</div>
                        </div>
                        <div class="ins-tab-content" data-tab="preview">
                            <iframe class="preview-mini-frame" srcdoc="${escapeHtml(previewBlob)}"></iframe>
                        </div>
                    </div>
                </div>
            `;
        }

        function inspectIframe(winId) {
            if (state.focusedWindowId !== winId) return;
            const winData = state.activeWindows.find(w => w.id === winId);
            const inspector = document.getElementById('inspector-root');
            
            if (!winData || winData.type === 'db' || winData.type === 'config') {
                inspector.innerHTML = `<div class="p-6 text-center text-xs opacity-40 italic">Sistema interno: Sin inspección.</div>`;
                return;
            }

            const iframe = document.getElementById(`iframe-${winId}`);
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                let html = `<div class="p-3 bg-blue-600 text-white text-[11px] font-bold mb-1 shadow-sm uppercase tracking-tighter">APP_INSPECT: ${winData.title}</div>`;

                html += renderInspectorSection('ÁRBOL_DOM_EXPLORADOR', () => `<div class="text-[10px] overflow-x-auto">${buildDomTree(doc.documentElement)}</div>`, true);

                if (state.selectedDomNodes.size > 0) {
                    html += renderInspectorSection('ELEMENTOS_SELECCIONADOS', () => {
                        return Array.from(state.selectedDomNodes).map(path => {
                            const el = getElementByPath(doc, path);
                            if (!el) return '';
                            return renderElementInspector(`NODE: ${path} (${el.tagName.toLowerCase()})`, el.outerHTML, `sel-${path}`);
                        }).join('');
                    }, true);
                }

                html += renderInspectorSection('ESTRUCTURA_LAYOUT', () => {
                    const tags = ['header', 'nav', 'main', 'aside', 'footer'];
                    return tags.map(tag => {
                        const el = doc.querySelector(tag);
                        if (!el) return `<div class="text-[9px] p-2 bg-gray-50 text-gray-400 mb-1 rounded border">${tag}: NO_ENCONTRADO</div>`;
                        return renderElementInspector(`LAYOUT: ${tag.toUpperCase()}`, el.outerHTML, `lay-${tag}`);
                    }).join('');
                });

                html += renderInspectorSection('SCRIPTS_DETECTADOS', () => {
                    const scripts = Array.from(doc.querySelectorAll('script'));
                    if (scripts.length === 0) return `<div class="text-[9px] opacity-40">No hay scripts internos.</div>`;
                    return scripts.map((s, i) => {
                        const label = s.src ? `SRC: ${s.src.split('/').pop()}` : `SCRIPT_INTERNO_${i+1}`;
                        const content = s.src ? `// Script externo cargado desde: ${s.src}` : s.innerHTML;
                        return `<div class="mb-2 p-2 bg-slate-50 border rounded"><div class="text-[8px] font-mono font-bold text-blue-800 mb-1">${label}</div><div class="code-snippet">${escapeHtml(content || '// Script vacío')}</div></div>`;
                    }).join('');
                });

                html += renderInspectorSection('ESTILOS_CSS_INTERNOS', () => {
                    const styles = Array.from(doc.querySelectorAll('style'));
                    if (styles.length === 0) return `<div class="text-[9px] opacity-40">No hay estilos internos.</div>`;
                    return styles.map((s, i) => `<div class="mb-2 p-2 bg-slate-50 border rounded"><div class="text-[8px] font-mono font-bold text-pink-800 mb-1">STYLE_BLOCK_${i+1}</div><div class="code-snippet">${escapeHtml(s.innerHTML || '/* Bloque vacío */')}</div></div>`).join('');
                });

                inspector.innerHTML = html;
            } catch (e) {
                inspector.innerHTML = `<div class="p-8 text-center text-red-500 text-xs font-mono">CORS_ERROR: ACCESO_DENEGADO (Probablemente debido a la política de seguridad del sitio externo o falta del archivo local).</div>`;
            }
        }

        function renderInspectorSection(title, contentFn, autoActive = false) {
            return `<div class="inspector-item border-b"><div class="inspector-section-header" onclick="toggleInspectorItem(this)"><span>${title}</span><span class="toggle-icon text-[8px]">${autoActive ? '▼' : '▶'}</span></div><div class="inspector-section-content ${autoActive ? 'active' : ''}">${contentFn()}</div></div>`;
        }

        function buildDomTree(element, path = "0") {
            const children = Array.from(element.children).filter(el => !['SCRIPT', 'STYLE'].includes(el.tagName));
            const hasChildren = children.length > 0;
            const nodeName = element.tagName.toLowerCase();
            let html = `<div class="dom-tree-item"><div class="dom-tree-label"><span class="dom-tree-toggle" onclick="toggleTreeNode(event, this)">${hasChildren ? '▼' : '&nbsp;'}</span><input type="checkbox" class="w-3 h-3 rounded" ${state.selectedDomNodes.has(path) ? 'checked' : ''} onchange="handleNodeCheck(this, '${state.focusedWindowId}', '${path}')"><span class="text-blue-600 font-bold">&lt;${nodeName}&gt;</span></div>`;
            if (hasChildren) {
                html += `<div class="dom-tree-node">`;
                children.forEach((child, index) => html += buildDomTree(child, `${path}-${index}`));
                html += `</div>`;
            }
            html += `</div>`;
            return html;
        }

        function handleNodeCheck(checkbox, winId, nodePath) {
            if (checkbox.checked) state.selectedDomNodes.add(nodePath);
            else state.selectedDomNodes.delete(nodePath);
            inspectIframe(winId);
        }

        function getElementByPath(doc, path) {
            const indices = path.split('-').map(Number);
            let current = doc.documentElement;
            for (let i = 1; i < indices.length; i++) {
                const cleanChildren = Array.from(current.children).filter(el => !['SCRIPT', 'STYLE'].includes(el.tagName));
                current = cleanChildren[indices[i]];
            }
            return current;
        }

        function toggleInspectorItem(header) {
            $(header).next('.inspector-section-content').toggleClass('active');
            const icon = $(header).find('.toggle-icon');
            icon.text(icon.text() === '▼' ? '▶' : '▼');
        }

        function toggleTreeNode(event, node) {
            event.stopPropagation();
            const children = $(node).closest('.dom-tree-item').find('> .dom-tree-node');
            children.toggleClass('hidden');
            $(node).text(children.hasClass('hidden') ? '▶' : '▼');
        }

        // --- UI UTILS ---

        function focusWindow(id) {
            $('.window-card').css('z-index', 10);
            $(`#${id}`).css('z-index', 50);
            state.focusedWindowId = id;
            updateWindowsNav();
            if ($(`#${id}`).data('type') === 'config') renderConfig(id);
            else inspectIframe(id);
        }

        function removeWindow(id, type) {
            $(`#${id}`).remove();
            state.activeWindows = state.activeWindows.filter(w => w.id !== id);
            if (type === 'db') state.internalOpen.db = false;
            if (type === 'config') state.internalOpen.config = false;
            updateSystemNavButtons();
            updateWindowsNav();
            if (state.focusedWindowId === id) {
                state.focusedWindowId = null;
                document.getElementById('inspector-root').innerHTML = '<div class="p-10 text-center opacity-30 text-xs">Esperando selección...</div>';
            }
        }

        function toggleSection(id) {
            const c = (id === 'header' || id === 'footer') ? 'collapsed-h' : 'collapsed-w';
            const section = $(`#${id}`);
            section.toggleClass(c);
            if (id === 'aside') $('#aside-expand-btn').toggleClass('hidden', !section.hasClass(c));
            else if (id === 'header') $('#header-expand-btn').toggle(section.hasClass(c));
            else if (id === 'footer') $('#footer-expand-btn').toggle(section.hasClass(c));
        }

        function toggleNav() { $('#nav').toggleClass('nav-expanded nav-collapsed'); }
        function updateSystemNavButtons() {
            $('#btn-nav-db').toggleClass('btn-nav-locked', state.internalOpen.db);
            $('#btn-nav-config').toggleClass('btn-nav-locked', state.internalOpen.config);
        }

        function updateWindowsNav() {
            document.getElementById('win-links-container').innerHTML = state.activeWindows.map(win => `
                <button onclick="focusWindow('${win.id}')" class="nav-item-btn flex items-center gap-3 w-full px-3 py-2 text-[10px] truncate rounded ${state.focusedWindowId === win.id ? 'bg-blue-50 text-blue-600 font-bold border-l-2 border-blue-600' : 'hover:bg-gray-100'}">
                    ${ICONS[win.type] || ICONS.module}
                    <span class="nav-text truncate">${win.title}</span>
                </button>
            `).join('');
        }

        function handleUrlSubmit() {
            let url = document.getElementById('external-url').value;
            if(!url) return;
            
            const isRelative = url.startsWith('.') || url.startsWith('/');
            const hasProtocol = /^https?:\/\//i.test(url) || url.startsWith('blob:');
            
            if(!isRelative && !hasProtocol) {
                url = 'https://' + url;
            }
            
            createWindowCard(url.split('//')[1] || url, url, 'web');
            document.getElementById('external-url').value = '';
        }

        function handleHtmlUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const blob = new Blob([e.target.result], { type: 'text/html' });
                createWindowCard(file.name, URL.createObjectURL(blob), 'module');
            };
            reader.readAsText(file);
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        async function renderDB(winId) {
            const c = document.getElementById(`content-${winId}`);
            if (!c) return;
            const bms = await db.bookmarks.toArray();
            c.innerHTML = `
                <div class="space-y-4">
                    <h3 class="font-bold border-b pb-2">EXPLORADOR_DEXIE</h3>
                    <div class="p-2 bg-gray-50 border rounded">
                        <div class="text-[9px] font-bold mb-1">TABLA: bookmarks (${bms.length})</div>
                        <pre class="text-[8px] opacity-60">${JSON.stringify(bms, null, 2)}</pre>
                    </div>
                </div>`;
        }

        async function renderConfig(winId) {
            const c = document.getElementById(`content-${winId}`);
            if (!c) return;
            const bms = await db.bookmarks.toArray();
            
            c.innerHTML = `
                <div class="space-y-6">
                    <section class="pb-4 border-b">
                        <h3 class="font-bold text-xs mb-3 text-purple-600 uppercase tracking-widest">Apariencia</h3>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border">
                            <span class="text-xs font-bold">Modo Oscuro (Dark Mode)</span>
                            <button onclick="toggleDarkMode()" class="px-4 py-1 rounded-full text-[10px] font-bold border transition-all ${state.darkMode ? 'bg-indigo-600 text-white border-indigo-700' : 'bg-white text-gray-600 border-gray-300'}">
                                ${state.darkMode ? 'ON' : 'OFF'}
                            </button>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold text-xs mb-3 text-blue-600 uppercase tracking-widest">Añadir Marcador</h3>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" id="bm-title" placeholder="Nombre (ej: App Local)" class="p-2 border rounded bg-gray-50">
                            <input type="text" id="bm-url" placeholder="URL o Ruta (../App/idx.html)" class="p-2 border rounded bg-gray-50">
                        </div>
                        <p class="text-[9px] text-gray-400 mb-2 italic">Puedes usar rutas relativas como "./archivo.html" o "../Apps/index.html".</p>
                        <button onclick="addBookmark()" class="w-full py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">GUARDAR_MARCADOR</button>
                    </section>

                    <section>
                        <h3 class="font-bold text-xs mb-3 text-gray-500 uppercase tracking-widest">URLs / Rutas Guardadas (${bms.length})</h3>
                        <div class="space-y-2">
                            ${bms.length === 0 ? '<p class="opacity-40 italic">No hay marcadores.</p>' : bms.map(bm => `
                                <div class="flex items-center justify-between p-2 bg-gray-50 border rounded group">
                                    <div class="truncate">
                                        <div class="font-bold text-gray-800">${bm.title}</div>
                                        <div class="text-[9px] opacity-50">${bm.url}</div>
                                    </div>
                                    <button onclick="deleteBookmark(${bm.id})" class="text-red-400 opacity-0 group-hover:opacity-100 px-2 font-bold">ELIMINAR</button>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>`;
        }

        // Run On Start
        $(document).ready(() => {
            initTheme();
        });
    </script>
</body>
</html>
